---
import Base from "@layouts/Base.astro";
import { isIndexableQuestion, loadQuestions } from "@/lib/generated";

export async function getStaticPaths() {
  const questions = await loadQuestions();
  const tags = new Set<string>();
  for (const q of questions.filter(isIndexableQuestion)) {
    for (const tag of q.tags || []) tags.add(tag);
  }
  return [...tags].sort().map((tag) => ({ params: { tag } }));
}

const { tag } = Astro.params;
const questions = await loadQuestions();
const matches = questions
  .filter((q) => isIndexableQuestion(q) && (q.tags || []).includes(String(tag)))
  .slice(0, 200);
---

<Base title={`Tag: ${tag}`} description={`Perl pages tagged ${tag}.`} robots="noindex,follow">
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold mb-2">#{tag}</h1>
    <p class="text-gray-600 dark:text-gray-400 mb-8">
      Showing {matches.length} pages (tag pages are not indexed).
    </p>

    {matches.length === 0 ? (
      <div class="p-6 rounded-xl border border-gray-200 dark:border-dark-700 bg-gray-50 dark:bg-dark-800">
        <p class="text-gray-700 dark:text-gray-300">No pages for this tag yet.</p>
      </div>
    ) : (
      <ul class="space-y-3">
        {matches.map((q) => (
          <li>
            <a
              href={`/questions/${q.slug}`}
              class="block p-4 rounded-lg border border-gray-200 dark:border-dark-700 hover:border-perl-500 dark:hover:border-perl-500 transition-colors"
            >
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                {q.category} â€¢ {q.difficulty}
              </div>
              <div class="font-medium">{q.title}</div>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Base>

